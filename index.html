<!doctype html>
<html lang="ro">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Consum & €/km (iPhone PWA)</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#19c37d">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <style>
    :root { --bg:#0b0f14; --card:#111820; --text:#eaf2f7; --muted:#9fb3c8; --accent:#19c37d; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;background:rgba(11,15,20,.9);backdrop-filter:saturate(180%) blur(8px);border-bottom:1px solid #223;z-index:10}
    header .wrap{max-width:900px;margin:auto;display:flex;align-items:center;gap:.6rem;padding:.8rem 1rem}
    h1{font-size:1.1rem;margin:0;font-weight:650;letter-spacing:.2px}
    main{max-width:900px;margin:1rem auto;padding:0 1rem;display:grid;gap:1rem}
    .card{background:var(--card);border:1px solid #1e2a36;border-radius:14px;padding:1rem}
    .grid{display:grid;gap:.7rem}
    .fields{display:grid;grid-template-columns:1fr 1fr;gap:.7rem}
    .fields>label{display:grid;gap:.25rem;font-size:.9rem;color:var(--muted)}
    input,button{width:100%;padding:.7rem .8rem;border-radius:10px;border:1px solid #2a3a4a;background:#0b1219;color:var(--text)}
    .row{display:flex;gap:.6rem;flex-wrap:wrap}
    button{background:var(--accent);color:#061;font-weight:700;border:none;cursor:pointer}
    button.ghost{background:transparent;border:1px solid #2a3a4a;color:var(--text)}
    .pill{display:inline-block;padding:.2rem .5rem;border-radius:999px;background:#0e1e15;color:#6fe0b1;border:1px solid #163; font-size:.8rem}
    table{width:100%;border-collapse:collapse;margin-top:.6rem;font-size:.93rem}
    th,td{padding:.6rem;border-bottom:1px solid #213040;text-align:left;vertical-align:top}
    th{color:var(--muted);font-weight:600}
    .right{text-align:right}
    .muted{color:var(--muted)}
    .thumb{width:40px;height:40px;border-radius:8px;object-fit:cover;border:1px solid #2a3a4a}
    @media (max-width:700px){ .fields{grid-template-columns:1fr} header .wrap{justify-content:space-between} }
    .warn{background:#331; border-color:#633; color:#f7c6c6}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <img src="icons/icon-192.png" alt="" width="28" height="28" style="border-radius:6px">
      <h1>Consum & €/km</h1>
      <span class="pill" id="installPill" style="margin-left:auto;display:none">Instalează</span>
    </div>
  </header>

  <main>
    <section class="card grid">
      <h2 style="margin:0">Adaugă alimentare</h2>
      <div class="fields">
        <label>Data
          <input type="date" id="date">
        </label>
        <label>Odometer (km)
          <input type="number" id="odometer" step="1" min="0" placeholder="km din bord">
        </label>
        <label>Litri
          <input type="number" id="liters" step="0.01" min="0" placeholder="ex: 300">
        </label>
        <label>Preț/L (€) sau Cost total (€)
          <div class="row" style="gap:.4rem">
            <input type="number" id="price_per_liter" step="0.001" min="0" placeholder="€/L">
            <input type="number" id="total_cost" step="0.01" min="0" placeholder="Cost €">
          </div>
          <small class="muted">Completează ori **€/L**, ori **Cost total** — programul calculează restul.</small>
        </label>
        <label>Plin‑plin?
          <input type="checkbox" id="full_tank"> <span class="muted">bifează doar când faci plinul</span>
        </label>
        <label>Factura (poză)
          <input type="file" id="invoice" accept="image/*">
        </label>
        <label>Notițe
          <input type="text" id="notes" placeholder="locație, card, traseu etc.">
        </label>
      </div>
      <div class="row">
        <button id="addBtn">Adaugă</button>
        <button class="ghost" id="exportBtn">Export CSV</button>
        <button class="ghost" id="clearBtn">Șterge tot</button>
      </div>
      <small class="muted">Datele rămân local pe telefon. PWA — funcționează și offline.</small>
    </section>

    <section class="card">
      <h2 style="margin:0 0 .4rem 0">Statistici</h2>
      <div class="row">
        <div class="pill" id="totalFuel">0 L</div>
        <div class="pill" id="totalCost">0 €</div>
        <div class="pill" id="avgConsumption">— L/100km</div>
        <div class="pill" id="costPerKm">— €/km</div>
      </div>
    </section>

    <section class="card">
      <h2 style="margin:0 0 .4rem 0">Alimentări</h2>
      <table id="table">
        <thead>
          <tr>
            <th>Data</th><th>Odo</th><th>Litri</th><th>€/L</th><th>Cost</th><th>Plin</th><th>Consum</th><th>€/km</th><th>Factură</th><th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </main>

  <footer style="text-align:center;color:#9fb3c8;padding:1.2rem">Creat pentru iPhone • Instalabil ca PWA</footer>

<script>
// PWA install prompt
let deferredPrompt;
const pill = document.getElementById('installPill');
window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; pill.style.display = 'inline-block'; });
pill?.addEventListener('click', async () => { if (!deferredPrompt) return; deferredPrompt.prompt(); await deferredPrompt.userChoice; pill.style.display='none'; deferredPrompt=null; });

// Storage
const KEY='fuel_pwa_full_v1';
const load=()=>JSON.parse(localStorage.getItem(KEY)||'[]');
const save=(a)=>localStorage.setItem(KEY,JSON.stringify(a));

// Helpers
function format(n,d=2){ return (n===null||isNaN(n)) ? '—' : Number(n).toFixed(d); }
function normalizeNumber(s){
  if (typeof s==='number') return s;
  if (!s) return NaN;
  let t = (''+s).replace(/[^0-9.,-]/g,'');
  if (t.includes(',') && !t.includes('.')) t=t.replace(',','.');
  if ((t.match(/[,\.]/g)||[]).length>1) t=t.replace(/[,.]/g,'');
  return parseFloat(t);
}

// Compute between last full-tank and current
function computeRow(data, idx){
  const item = data[idx];
  // find last full before idx (excluding idx)
  let prevIndex = -1;
  for (let i=idx-1;i>=0;i--) if (data[i].full_tank){ prevIndex=i; break; }
  const prevOdo = prevIndex>=0 ? data[prevIndex].odometer : null;
  const km = (prevOdo!=null) ? (item.odometer - prevOdo) : null;

  const cost = (!isNaN(item.total_cost) && item.total_cost>0) ? item.total_cost : (item.liters * item.price_per_liter);
  const cons = (km && km>0) ? (item.liters / km * 100) : null;
  const cpk = (km && km>0 && cost!=null) ? (cost / km) : null;
  const price = (isNaN(item.price_per_liter) || item.price_per_liter<=0) && item.liters>0 ? (cost / item.liters) : item.price_per_liter;
  return { km, cons, cost, cpk, price };
}

function validate(entry, prev){
  const warns=[];
  if (isNaN(entry.odometer) || entry.odometer<=0) warns.push('Odometer invalid.');
  if (prev && entry.odometer<=prev.odometer) warns.push('Odometer mai mic/egal decât înregistrarea anterioară.');
  if (isNaN(entry.liters) || entry.liters<10 || entry.liters>1500) warns.push('Litri în afara intervalului 10–1500.');
  const price = entry.price_per_liter; const total = entry.total_cost;
  if ((isNaN(price)||price<=0) && (isNaN(total)||total<=0)) warns.push('Completează €/L sau Cost total.');
  if (!isNaN(price) && (price<0.5 || price>4)) warns.push('€/L în afara intervalului 0,5–4.');
  if (!isNaN(total) && total<10) warns.push('Cost total prea mic (<10€).');
  return warns;
}

// Elements
const tbody=document.querySelector('#table tbody');
const addBtn=document.getElementById('addBtn');
const exportBtn=document.getElementById('exportBtn');
const clearBtn=document.getElementById('clearBtn');

async function fileToDataURL(file){
  return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); });
}

addBtn.addEventListener('click', async ()=>{
  const date = document.getElementById('date').value || new Date().toISOString().slice(0,10);
  const odometer = normalizeNumber(document.getElementById('odometer').value);
  const liters = normalizeNumber(document.getElementById('liters').value);
  const price = normalizeNumber(document.getElementById('price_per_liter').value);
  const total = normalizeNumber(document.getElementById('total_cost').value);
  const full_tank = document.getElementById('full_tank').checked;
  const notes = document.getElementById('notes').value.trim();
  const file = document.getElementById('invoice').files[0];
  const arr = load().sort((a,b)=>a.odometer-b.odometer);
  const prev = arr.length ? arr[arr.length-1] : null;

  const entry = { id: Date.now(), date, odometer, liters, price_per_liter: price, total_cost: total, full_tank, notes, invoice:null };
  const warns = validate(entry, prev);
  if (warns.length){
    alert('Verifică:
- '+warns.join('
- '));
    return;
  }
  if (file){ try{ entry.invoice = await fileToDataURL(file); }catch(e){ console.error(e); } }
  arr.push(entry);
  save(arr);
  ['odometer','liters','price_per_liter','total_cost','notes','invoice','full_tank'].forEach(id=>{
    const el=document.getElementById(id);
    if(!el) return;
    if (el.type==='checkbox') el.checked=false;
    else el.value='';
  });
  refresh();
});

tbody.addEventListener('click',(e)=>{
  const b=e.target.closest('button[data-id]'); if(!b) return;
  const id=Number(b.dataset.id);
  const arr=load().filter(x=>x.id!==id);
  save(arr); refresh();
});

function toCSV(){
  const header=['date','odometer','liters','price_per_liter','total_cost','full_tank','computed_cost','cons_l_per_100km','cost_per_km','notes'];
  const lines=[header.join(',')];
  const data=load().sort((a,b)=>a.odometer-b.odometer);
  data.forEach((item,i)=>{
    const r=computeRow(data,i);
    lines.push([item.date,item.odometer,item.liters,r.price,item.total_cost||'',item.full_tank,r.cost||'',r.cons||'',r.cpk||'',(item.notes||'').replace(/,/g,';')].join(','));
  });
  return lines.join('\n');
}

exportBtn.addEventListener('click', ()=>{
  const blob=new Blob([toCSV()],{type:'text/csv'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='consum_cost_pe_km.csv'; a.click();
});

clearBtn.addEventListener('click', ()=>{
  if(confirm('Ștergi toate alimentările?')){ localStorage.removeItem(KEY); refresh(); }
});

function refresh(){
  const data=load().sort((a,b)=>a.odometer-b.odometer);
  tbody.innerHTML='';
  let totalFuel=0,totalCost=0,totalKm=0,lastFullOdo=null;
  data.forEach((item,i)=>{
    const r=computeRow(data,i);
    totalFuel += item.liters||0;
    totalCost += r.cost||0;
    if (item.full_tank){
      if (lastFullOdo!=null && item.odometer>lastFullOdo) totalKm += (item.odometer - lastFullOdo);
      lastFullOdo = item.odometer;
    }
    const thumb = item.invoice ? `<img class="thumb" src="${item.invoice}">` : '<span class="muted">—</span>';
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${item.date||''}</td>
      <td class="right">${item.odometer}</td>
      <td class="right">${format(item.liters,2)}</td>
      <td class="right">${format(r.price,3)}</td>
      <td class="right">${format(r.cost,2)}</td>
      <td>${item.full_tank?'✔️':''}</td>
      <td class="right">${format(r.cons,2)} L/100km</td>
      <td class="right">${format(r.cpk,3)}</td>
      <td>${thumb}</td>
      <td class="right"><button class="ghost" data-id="${item.id}">Șterge</button></td>`;
    tbody.appendChild(tr);
  });
  const avgCons = totalKm>0 ? (totalFuel/totalKm*100) : null;
  const cpk = totalKm>0 ? (totalCost/totalKm) : null;
  document.getElementById('totalFuel').textContent = format(totalFuel,2)+' L';
  document.getElementById('totalCost').textContent = format(totalCost,2)+' €';
  document.getElementById('avgConsumption').textContent = (avgCons?format(avgCons,2):'—')+' L/100km';
  document.getElementById('costPerKm').textContent = (cpk?format(cpk,3):'—')+' €/km';
}

// SW
if('serviceWorker' in navigator){ window.addEventListener('load',()=>{ navigator.serviceWorker.register('sw.js'); }); }
refresh();
</script>
</body>
</html>
