<!DOCTYPE html>
<html lang="ro">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>GSE International • Consum L/100 km</title>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#19c37d">
<style>
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;background:#f6f7f9;color:#0b0f14}
header{background:#19c37d;color:#fff;padding:14px;text-align:center;font-weight:700}
main{max-width:820px;margin:0 auto;padding:14px}
.card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:12px;margin:12px 0}
label{display:block;margin-top:8px;font-size:.95rem;color:#374151}
input,button,select{width:100%;padding:10px;border:1px solid #d1d5db;border-radius:10px;margin-top:6px;background:#fff}
.row{display:flex;gap:8px;flex-wrap:wrap}
.row>*{flex:1 1 200px}
table{width:100%;border-collapse:collapse;margin-top:10px;font-size:.95rem}
th,td{border:1px solid #e5e7eb;padding:8px;text-align:center}
th{background:#19c37d;color:#fff}
.pill{display:inline-block;background:#ecfdf5;border:1px solid #19c37d;color:#065f46;border-radius:999px;padding:3px 8px;margin-right:6px}
.danger{border-color:#ef4444;color:#ef4444}
</style>
</head>
<body>
<header>GSE International • Consum L/100 km</header>
<main>
<div class="card">
  <div class="row"><div class="pill">Data curentă: <span id="nowStamp"></span></div></div>

  <div class="row">
    <div><label>Odometer (km)<input type="text" id="odometer" inputmode="decimal"></label></div>
    <div><label>Litri<input type="text" id="liters" inputmode="decimal"></label></div>
  </div>
  <div class="row">
    <div><label>Cost total (€) — opțional<input type="text" id="total_cost" inputmode="decimal"></label></div>
    <div><label>Plin-plin?<input type="checkbox" id="full_tank"></label></div>
  </div>

  <div class="row" style="margin-top:8px">
    <button id="addBtn">Adaugă</button>
    <button id="deleteLastBtn">Șterge ultima</button>
    <button id="resetBtn" class="danger">Resetează tot</button>
  </div>

  <div class="row" style="margin-top:8px">
    <div><label>Lună pentru export PDF<input type="month" id="monthPicker"></label></div>
    <div style="align-self:end"><button id="exportPdfBtn">Export PDF</button></div>
  </div>
</div>

<div class="card">
  <div>
    <span class="pill" id="statFuel">0 L</span>
    <span class="pill" id="statCost">0 €</span>
    <span class="pill" id="statL100">— L/100 km</span>
  </div>
</div>

<div class="card">
  <table>
    <thead><tr><th>Data</th><th>Ora</th><th>Odo</th><th>Litri</th><th>Cost €</th><th>Plin</th><th>L/100 km</th></tr></thead>
    <tbody id="rows"></tbody>
  </table>
</div>
</main>

<script>
// ===== Utils & storage =====
const KEY='gse_fuel_entries';
const el=id=>document.getElementById(id);
function nowISO(){const d=new Date();return{iso:d.toISOString(),date:d.toLocaleDateString('ro-RO'),time:d.toLocaleTimeString('ro-RO',{hour:'2-digit',minute:'2-digit'})};}
function normalizeNumber(s){if(typeof s==='number')return s;if(!s)return NaN;let t=(''+s).replace(/[^0-9.,-]/g,'');if(t.includes(',')&&!t.includes('.'))t=t.replace(',','.');if((t.match(/[,\.]/g)||[]).length>1)t=t.replace(/[,.]/g,'');return parseFloat(t);}
function load(){return JSON.parse(localStorage.getItem(KEY)||'[]');}
function save(a){localStorage.setItem(KEY,JSON.stringify(a));}
function fmt(n,d=2){return(n==null||isNaN(n))?'':Number(n).toFixed(d);}

// consum calculat între plinuri (folosește ultimul rând cu full_tank dinaintea celui curent)
function computeRow(data,idx){
  const it=data[idx]; let prev=-1; for(let i=idx-1;i>=0;i--) if(data[i].full_tank){prev=i;break;}
  const prevOdo=prev>=0?data[prev].odometer:null;
  const km=(prevOdo!=null)?(it.odometer-prevOdo):null;
  const cons=(km&&km>0)?(it.liters/km*100):null;
  return {cons};
}

// UI refresh
function refresh(){
  const data=load().sort((a,b)=>a.odometer-b.odometer);
  const tb=el('rows');tb.innerHTML='';
  let totalFuel=0,totalCost=0,totalKm=0,lastFull=null;
  data.forEach((it,i)=>{
    const r=computeRow(data,i);
    totalFuel+=it.liters||0;
    if(it.total_cost) totalCost+=it.total_cost;
    if(it.full_tank){ if(lastFull!=null && it.odometer>lastFull) totalKm+=(it.odometer-lastFull); lastFull=it.odometer; }
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${it.date}</td><td>${it.time}</td><td>${it.odometer}</td><td>${fmt(it.liters,2)}</td><td>${fmt(it.total_cost,2)}</td><td>${it.full_tank?'✔':''}</td><td>${fmt(r.cons,2)}</td>`;
    tb.appendChild(tr);
  });
  const avg=totalKm>0?(totalFuel/totalKm*100):null;
  el('statFuel').textContent=`${fmt(totalFuel,2)} L`;
  el('statCost').textContent=`${fmt(totalCost,2)} €`;
  el('statL100').textContent=`${avg?fmt(avg,2):'—'} L/100 km`;
  const n=nowISO(); el('nowStamp').textContent=`${n.date} ${n.time}`;
}

// ===== Actions =====
el('addBtn').addEventListener('click',()=>{
  const odo=normalizeNumber(el('odometer').value);
  const lit=normalizeNumber(el('liters').value);
  const total=normalizeNumber(el('total_cost').value);
  const full=el('full_tank').checked;
  if(isNaN(odo)||isNaN(lit)){ alert('Completează Odometer și Litri.'); return; }
  const ts=nowISO(); const arr=load();
  arr.push({timestamp:ts.iso,date:ts.date,time:ts.time,odometer:odo,liters:lit,total_cost:total,full_tank:full});
  save(arr);
  ['odometer','liters','total_cost'].forEach(id=>el(id).value=''); el('full_tank').checked=false; refresh();
});

// Șterge ultima înregistrare (ultima adăugată)
el('deleteLastBtn').addEventListener('click',()=>{
  const arr=load();
  if(!arr.length){ alert('Nu există înregistrări.'); return; }
  if(confirm('Ștergi ultima înregistrare adăugată?')){
    arr.pop(); // ultima adăugată
    save(arr); refresh();
  }
});

// Reset total
el('resetBtn').addEventListener('click',()=>{
  if(confirm('Ștergi toate înregistrările?')){
    localStorage.removeItem(KEY);
    refresh();
  }
});

// ===== PDF loader cu fallback (2 CDN-uri) =====
function loadScript(src){return new Promise((res,rej)=>{const s=document.createElement('script');s.src=src;s.async=true;s.crossOrigin='anonymous';s.onload=res;s.onerror=()=>rej(new Error('load fail: '+src));document.head.appendChild(s);});}
async function ensureJsPDF(){
  if (window.jspdf?.jsPDF?.API?.autoTable) return;
  try{ if(!window.jspdf) await loadScript('https://cdn.jsdelivr.net/npm/jspdf@2.5.2/dist/jspdf.umd.min.js'); }
  catch{ await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.2/jspdf.umd.min.js'); }
  try{ if(!window.jspdf?.jsPDF?.API?.autoTable) await loadScript('https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js'); }
  catch{ await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js'); }
  if(!window.jspdf || !window.jspdf.jsPDF) throw new Error('jsPDF n-a pornit');
}

// Export PDF (include L/100 km în tabel)
el('exportPdfBtn').addEventListener('click', async ()=>{
  const val=el('monthPicker').value; if(!val){ alert('Alege o lună.'); return; }
  try{
    await ensureJsPDF(); const { jsPDF } = window.jspdf;
    const [yy,mm]=val.split('-').map(x=>parseInt(x,10));
    const all=load();
    // Sortăm tot setul pentru calcul corect al consumului, apoi selectăm din lună
    const sorted=[...all].sort((a,b)=>a.odometer-b.odometer);
    const rowsIdx = sorted.map((r,i)=>({r,i})).filter(({r})=>{
      const d=new Date(r.timestamp); return d.getFullYear()===yy && (d.getMonth()+1)===mm;
    });
    if(!rowsIdx.length){ alert('Nu sunt date.'); return; }

    let totL=0, totE=0;
    const body = rowsIdx.map(({r,i})=>{
      const cons = computeRow(sorted,i).cons;
      totL += (r.liters||0); if(r.total_cost) totE += r.total_cost;
      return [r.date, r.time, r.odometer, r.liters, r.total_cost ?? '', r.full_tank?'✔':'', cons?Number(cons).toFixed(2):''];
    });

    const doc=new jsPDF();
    doc.setFontSize(14); doc.text(`GSE International — Alimentări ${mm}/${yy}`,14,16);
    doc.autoTable({ head:[['Data','Ora','Odo','Litri','Cost €','Plin','L/100 km']], body, startY:22, styles:{fontSize:9} });
    const y=doc.autoTable.previous.finalY+8; doc.setFontSize(12);
    doc.text(`Total litri: ${totL.toFixed(2)}    Total cost: ${totE.toFixed(2)} €`,14,y);

    try{ doc.save(`alimentari_${yy}-${String(mm).padStart(2,'0')}.pdf`); }
    catch{ const blob=doc.output('blob'); const url=URL.createObjectURL(blob); window.open(url,'_blank'); }
  }catch(e){ console.error(e); alert('Nu pot genera PDF-ul (internet sau cache). Încearcă din nou.'); }
});

// PWA SW
if('serviceWorker' in navigator){ window.addEventListener('load',()=>{ navigator.serviceWorker.register('sw.js'); }); }

// init
function tick(){ const n=nowISO(); el('nowStamp').textContent=`${n.date} ${n.time}`; }
setInterval(tick,1000); tick();
refresh();
</script>
</body>
</html>
